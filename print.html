<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Tenet Documentation</title>
                <meta name="robots" content="noindex" />
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">Tenet</a></li><li class="chapter-item expanded affix "><li class="part-title">User manual</li><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="usage.html"><strong aria-hidden="true">2.</strong> Usage</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="networkpolicytemplate.html"><strong aria-hidden="true">2.1.</strong> NetworkPolicyTemplate</a></li><li class="chapter-item expanded "><a href="networkpolicyadmissionrule.html"><strong aria-hidden="true">2.2.</strong> NetworkPolicyAdmissionRule</a></li><li class="chapter-item expanded "><a href="template_opt_in.html"><strong aria-hidden="true">2.3.</strong> Template Opt-in</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">Developer documents</li><li class="chapter-item expanded "><a href="release.html"><strong aria-hidden="true">3.</strong> Release procedure</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Tenet Documentation</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/cybozu-go/tenet" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="tenet"><a class="header" href="#tenet">Tenet</a></h1>
<p>Tenet is a Kubernetes controller that aims to facilitate setting-up Network Policies on tenant namespaces.</p>
<p>It is designed to work in conjunction with <a href="https://docs.cilium.io/en/stable/policy/">Cilium Network Policies</a> and <a href="https://cybozu-go.github.io/accurate/">Accurate</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Tenet is a Kubernetes controller that aims to facilitate setting-up Network Policies on tenant namespaces.</p>
<p>It is designed to work in conjunction with <a href="https://docs.cilium.io/en/stable/policy/">Cilium Network Policies</a> and <a href="https://cybozu-go.github.io/accurate/">Accurate</a>.</p>
<h2 id="motivation"><a class="header" href="#motivation">Motivation</a></h2>
<p>To enhance the security without sacrificing convenience, we want to provide default network policies for tenants to consume. For instance, we want egress communications to be disabled by default in tenant namespaces. Tenants should be able to add exceptions to fit the needs of their workflows while being prevented from adding exceptions that are too broad, i.e. grant access to <code>node</code> resources.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>Allow cluster administrators to provide network policy templates tenants can opt into
<ul>
<li>currently <code>CiliumNetworkPolicy</code> and <code>CiliumClusterwideNetworkPolicy</code> templates are supported</li>
</ul>
</li>
<li>Automatically generate network policies on namespaces that opt into them
<ul>
<li>when used in conjunction with <code>Accurate</code>, resource generation is also performed on SubNamespaces</li>
</ul>
</li>
<li>Allow cluster administrators to place restrictions on the expressivity of network policies
<ul>
<li>currently only IP address restrictions are supported</li>
</ul>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<p>Tenet provides two custom resources to cluster administrators: <a href="networkpolicytemplate.html"><code>NetworkPolicyTemplate</code></a> and <a href="networkpolicyadmissionrule.html"><code>NetworkPolicyAdmissionRule</code></a>.</p>
<p>Tenet provides the following annotation to users and tenants: <a href="user_annotations.html"><code>tenet.cybozu.io/network-policy-template</code></a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="networkpolicytemplate"><a class="header" href="#networkpolicytemplate">NetworkPolicyTemplate</a></h1>
<p><code>NetworkPolicyTemplate</code> enables administrators to write <code>CiliumNetworkPolicy</code> or <code>CiliumClusterwideNetworkPolicy</code> templates that tenants can opt-into via the <code>tenet.cybozu.io/network-policy-template</code> annotation in their <code>Namespace</code> resources. Templates can be supplied with values sources from the <code>.metadata</code> field of the <code>Namespace</code> resource that reference them. When annotations are placed on a root namespace managed by Accurate the annotations, and thus the templated CiliumNetworkPolicies, can be propagated to child namespaces. For instance, given the following <code>NetworkPolicyTemplate</code>,</p>
<pre><code class="language-yaml"># network-policy-template.yaml
apiVersion: tenet.cybozu.io/v1beta1
kind: NetworkPolicyTemplate
metadata:
    name: allow-intra-namespace-egress
spec:
    policyTemplate: |
      apiVersion: cilium.io/v2
      kind: CiliumNetworkPolicy
      metadata:
        name: allow-intra-namespace-egress
      spec:
        endpointSelector: {}
        egress:
        - toEndpoints:
          - matchLabels:
              &quot;k8s:io.kubernetes.pod.namespace&quot;: {{.Name}}
</code></pre>
<p>When a tenant namespace is annotated like below,</p>
<pre><code class="language-yaml"># namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: my-namespace
  annotations:
      tenet.cybozu.io/network-policy-template: allow-intra-namespace-egress
  labels:
      accurate.cybozu.com/type: root
</code></pre>
<p>The following <code>CiliumNetworkPolicy</code> gets created in the <code>my-namespace</code> namespace:</p>
<pre><code class="language-yaml">apiVersion: cilium.io/v2
kind: CiliumNetworkPolicy
metadata:
  name: allow-intra-namespace-egress
  namespace: my-namespace
spec:
  endpointSelector: {}
  egress:
  - toEndpoints:
    - matchLabels:
         &quot;k8s:io.kubernetes.pod.namespace&quot;: my-namespace
</code></pre>
<p>If <code>my-namespace</code> is an Accurate root namespace, any of its child namespace will inherit the <code>tenet.cybozu.io/network-policy-template</code> annotation and CiliumNetworkPolicies will be created with the templates filled-in.</p>
<p>To write <code>CiliumClusterwideNetworkPolicy</code> templates, set <code>.spec.clusterwide: true</code> on <code>NetworkPolicyTemplate</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="networkpolicyadmissionrule"><a class="header" href="#networkpolicyadmissionrule">NetworkPolicyAdmissionRule</a></h1>
<p>To restrict the scope of whitelist permissions tenants can write via CiliumNetworkPolicies or NetworkPolicies, cluster administrators can write <code>NetworkPolicyAdmissionRule</code> resources. This allows administrators to forbid the use of specific CIDR ranges as endpoint selectors for network policies. For instance, the following <code>NetworkPolicyAdmissionRule</code> will reject network policies in namespaces that do not hold the team: neco label, i.e. all tenant namespaces, from specifing IP addresses within the 10.72.16.0/20 range for egress rules.</p>
<pre><code class="language-yaml"># admission-rule.yaml
apiVersion: tenet.cybozu.io/v1beta1
kind: NetworkPolicyAdmissionRule
metadata:
    name: forbid-bmc
spec:
    namespaceSelector:
      excludeLabels:
        team: neco
    forbiddenIPRanges:
      - cidr: 10.72.16.0/20
        type: egress
</code></pre>
<p>IP address restrictions can be applied on ingress or egress type network policies. When <code>type: all</code> is specified, the restrictions apply to both ingress and egress.</p>
<h2 id="specifications"><a class="header" href="#specifications">Specifications</a></h2>
<h3 id="namespaceselector"><a class="header" href="#namespaceselector">namespaceSelector</a></h3>
<p>This selects namespaces for which the admission rules apply.</p>
<h3 id="forbiddenipranges"><a class="header" href="#forbiddenipranges">forbiddenIPRanges</a></h3>
<p>This defines IP ranges, in CIDR form, against which users cannot define network policies.</p>
<h3 id="forbiddenentities"><a class="header" href="#forbiddenentities">forbiddenEntities</a></h3>
<p>This defines Cilium entities that users are not allowed to refer to in their network policies.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="template-opt-in"><a class="header" href="#template-opt-in">Template Opt-in</a></h1>
<p>Tenants and users can opt into network policy templates via the following annotation placed on <code>Namespace</code> resources:</p>
<ul>
<li><code>tenet.cybozu.io/network-policy-template</code> - a comma-separated list of <code>NetworkPolicyTemplate</code> names</li>
</ul>
<p>In a cluster where cluster administrators have control over <code>Namespace</code> definitions, for instance in a situation where <a href="https://cybozu-go.github.io/accurate/">Accurate</a> is deployed and cluster administrators manage root namespaces, users will not be able to remove inherited annotations to bypass restrictions.</p>
<h2 id="example"><a class="header" href="#example">Example</a></h2>
<pre><code class="language-yaml"># namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: my-namespace
  annotations:
      tenet.cybozu.io/network-policy-template: allow-intra-namespace-egress,forbid-bmc
  labels:
      accurate.cybozu.com/type: root
</code></pre>
<p>This will create the appropriate CiliumNetworkPolicies as defined in the relevant NetworkPolicyTemplates.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="release-procedure"><a class="header" href="#release-procedure">Release procedure</a></h1>
<p>This document describes how to release a new version.</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>Follow <a href="https://semver.org/spec/v2.0.0.html">semantic versioning 2.0.0</a> to choose the new version number.</p>
<h2 id="prepare-change-log-entries"><a class="header" href="#prepare-change-log-entries">Prepare change log entries</a></h2>
<p>Add notable changes since the last release to <a href="CHANGELOG.html">CHANGELOG.md</a>.
It should look like:</p>
<pre><code class="language-markdown">(snip)
## [Unreleased]

### Added
- Implement ... (#35)

### Changed
- Fix a bug in ... (#33)

### Removed
- Deprecated `-option` is removed ... (#39)

(snip)
</code></pre>
<h2 id="bump-version"><a class="header" href="#bump-version">Bump version</a></h2>
<ol>
<li>
<p>Determine a new version number. Then set <code>VERSION</code> variable.</p>
<pre><code class="language-console"># Set VERSION and confirm it. It should not have &quot;v&quot; prefix.
$ VERSION=x.y.x
$ echo $VERSION
</code></pre>
</li>
<li>
<p>Make a branch to release</p>
<pre><code class="language-console">$ git neco dev &quot;$VERSION&quot;`
</code></pre>
</li>
<li>
<p>Edit <code>CHANGELOG.md</code> for the new version (<a href="https://github.com/cybozu-go/etcdpasswd/commit/77d95384ac6c97e7f48281eaf23cb94f68867f79">example</a>).</p>
</li>
<li>
<p>Commit the change and push it.</p>
<pre><code class="language-console">$ git commit -a -m &quot;Bump version to $VERSION&quot;
$ git neco review
</code></pre>
</li>
<li>
<p>Merge this branch.</p>
</li>
<li>
<p>Add a git tag to the main HEAD, then push it.</p>
<pre><code class="language-console"># Set VERSION again.
$ VERSION=x.y.x
$ echo $VERSION

$ git checkout main
$ git pull
$ git tag -a -m &quot;Release v$VERSION&quot; &quot;v$VERSION&quot;

# Make sure the release tag exists.
$ git tag -ln | grep $VERSION

$ git push origin &quot;v$VERSION&quot;
</code></pre>
</li>
</ol>
<p>GitHub actions will build and push artifacts such as container images and
create a new GitHub release.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
                        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
                
    </body>
</html>
